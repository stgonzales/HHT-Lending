<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk"
      crossorigin="anonymous"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta charset="UTF-8" />
    <title>HHT Lending App</title>
    <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline';"
    />
  </head>
  <body class="bg-dark">
    <div class="container">
      <div class="mx-auto pt-5 justify-content-center text-center">
        <h3 class="text-light">HHT Lending App</h3>
        <p class="text-light">
          A simple app to control Handheld Terminal lendings.
        </p>
        <form>
          <div class="form-group">
            <div class="col-5 mx-auto">
              <label for="hht" class="text-light">HHT Number</label>
              <input
                class="form-control"
                type="text"
                name="hht-number"
                id="hht"
              />
            </div>
          </div>
          <div class="form-group">
            <div class="col-5 mx-auto">
              <label for="user" class="text-light">USER Number</label>
              <input
                class="form-control"
                type="text"
                name="user-number"
                id="user"
              />
            </div>
          </div>
          <button type="button" class="btn btn-primary" onclick="submitMoviment('IN')">IN</button>
          <button type="button" class="btn btn-primary" onclick="submitMoviment('OUT')">OUT</button>
        </form>
      </div>
      <div class="pt-5 text-center text-light flex">
        <h4>Last Movements</h4>
        <!-- <button class="btn btn-primary" onclick="updateList()"> Update </button> -->
        <table class="table bg-white table-hover table-sm">
          <thead>
            <tr>
              <th scope="col">Moviment Date/Time</th>
              <th scope="col">HHT Number</th>
              <th scope="col">USER Number</th>
              <th scope="col">Moviment</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>

      <footer class="footer pt-5">
        <div class="text-center">
          <span class="text-muted"
            >Developed with &#128147; by S.Gonzales! &#129489;&#127998; &copy;
            <script type="text/javascript">
              let d = new Date();
              document.write(d.getFullYear());
            </script>
            &#127881;</span
          >
        </div>
      </footer>
    </div>

    <!-- Scripts -->
    <script>
      const electron = require('electron')
      const {ipcRenderer} = electron

      updateList()

      async function submitMoviment(m){
        let tempObj = {}
        tempObj.hht = document.getElementById('hht').value 
        tempObj.user = document.getElementById('user').value 
        tempObj.moviment = m

        if(tempObj.hht == '' || tempObj.user == ''){
          alert('Fields HHT and/or USER can\'t be blank!')
          resetForm()
          return;
        }
                
        const res = await ipcRenderer.sendSync('moviment:add', tempObj)
        
        updateList()
        resetForm()

      }

      function resetForm(){
        document.getElementById('hht').value = ''
        document.getElementById('user').value = ''
      }

      //NOT WORKING
      function validateInput() {
        let x = document.getElementById('hht').value
        let y = document.getElementById('user').value
        if(parseInt(x) !== /^[0-9]*$/gm || parseInt(y) !== /^[0-9]*$/gm){
          alert('Only use numbers!')
          resetForm()
          return
        }
      }

      function updateList(){
        const tableBody = document.querySelector('tbody')        
        const data = JSON.parse(ipcRenderer.sendSync('load'))

        if(tableBody.rows.length > 0){
          const newTableBody = document.createElement('tbody')

          for(obj of data){
            const tableRow = document.createElement('tr')
          
            for([key, value] of Object.entries(obj)){
        
              const tableData = document.createElement('td')
              
              tableData.innerText = value
              tableRow.appendChild(tableData)
            }        
            newTableBody.appendChild(tableRow)
          }
          tableBody.parentNode.replaceChild(newTableBody,tableBody)
        }
        else{

          for(obj of data){
            const tableRow = document.createElement('tr')
          
            for([key, value] of Object.entries(obj)){
        
              const tableData = document.createElement('td')
              
              tableData.innerText = value
              tableRow.appendChild(tableData)
            }        
            tableBody.appendChild(tableRow)
          }
        }

      }      

    </script>
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
      integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
